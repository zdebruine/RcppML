<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="RcppML">
<title>Getting Started with NMF • RcppML</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with NMF">
<meta property="og:description" content="RcppML">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">RcppML</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/annotating_nmf_models.html">Learning and Annotating NMF Models</a>
    <a class="dropdown-item" href="../articles/getting_started.html">Getting Started with NMF</a>
    <a class="dropdown-item" href="../articles/robust_nmf.html">Robust NMF with random initializations</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/zdebruine/RcppML/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting Started with NMF</h1>
                        <h4 data-toc-skip class="author">Zach
DeBruine</h4>
            
            <h4 data-toc-skip class="date">2022-09-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/zdebruine/RcppML/blob/HEAD/vignettes/getting_started.Rmd" class="external-link"><code>vignettes/getting_started.Rmd</code></a></small>
      <div class="d-none name"><code>getting_started.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates basic usage of the
<code><a href="../reference/nmf.html">RcppML::nmf</a></code> function and visualization of the results.</p>
<div class="section level2">
<h2 id="install-rcppml">Install RcppML<a class="anchor" aria-label="anchor" href="#install-rcppml"></a>
</h2>
<p>Install the RcppML R package from CRAN or the development version
from GitHub.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'RcppML'</span><span class="op">)</span>                     <span class="co"># install CRAN version</span></span>
<span><span class="co"># devtools::install_github("zdebruine/RcppML") # compile dev version</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="what-is-nmf">What is NMF?<a class="anchor" aria-label="anchor" href="#what-is-nmf"></a>
</h2>
<p>Non-negative Matrix Factorization (NMF) finds additive signals in
non-negative data in terms of the features and samples associated with
those signals.</p>
<p>NMF gives an approximation of an input matrix as the cross-product of
two low-rank submatrices:</p>
<p><span class="math display">\[A = wdh\]</span></p>
<p>Here, <span class="math inline">\(A\)</span> is the input matrix,
<span class="math inline">\(w\)</span> is a tall matrix of features in
rows and factors in columns, and <span class="math inline">\(h\)</span>
is a wide matrix of factors in rows and samples in columns.</p>
<p><code><a href="../reference/nmf.html">RcppML::nmf</a></code> introduces one more important component into
this system, a scaling diagonal, <span class="math inline">\(d\)</span>.
This scaling diagonal provides:</p>
<ul>
<li>consistent factor scalings throughout model fitting</li>
<li>robustness across random restarts</li>
<li>symmetry in factorization of symmetric matrices</li>
<li>a means for convex L1 regularization</li>
</ul>
</div>
<div class="section level2">
<h2 id="running-nmf">Running NMF<a class="anchor" aria-label="anchor" href="#running-nmf"></a>
</h2>
<p>Run NMF on the <code>iris</code> dataset. We need to specify a rank
(<code>k</code>) for the factorization, and will also specify the
<code>seed</code> for random initialization for reproducibility:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/zdebruine/RcppML" class="external-link">RcppML</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org/" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, k <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span></span>
<span><span class="co">#&gt; 150 x 4 x 3 factor model of class "nmf"</span></span>
<span><span class="co">#&gt; @ w</span></span>
<span><span class="co">#&gt;              nmf1         nmf2         nmf3</span></span>
<span><span class="co">#&gt; [1,] 0.0014403134 0.0002357974 0.0147753897</span></span>
<span><span class="co">#&gt; [2,] 0.0024259960            . 0.0129176731</span></span>
<span><span class="co">#&gt; [3,] 0.0014543773 0.0001794741 0.0134988417</span></span>
<span><span class="co">#&gt; [4,] 0.0019489186 0.0005632185 0.0124668937</span></span>
<span><span class="co">#&gt; [5,] 0.0001151302 0.0015972125 0.0148072020</span></span>
<span><span class="co">#&gt; [6,]            . 0.0030264275 0.0151420941</span></span>
<span><span class="co">#&gt; [7,]            . 0.0022133280 0.0132919365</span></span>
<span><span class="co">#&gt; ...suppressing 143 rows</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; @ d</span></span>
<span><span class="co">#&gt; 747.8924  726.0631  605.7889  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; @ h</span></span>
<span><span class="co">#&gt;      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co">#&gt; nmf1  0.426857790 0.123598613  0.355488027 0.094055570</span></span>
<span><span class="co">#&gt; nmf2  0.340537544 0.193888276  0.320817305 0.144756875</span></span>
<span><span class="co">#&gt; nmf3  0.511768434 0.372576543  0.107677454 0.007977569</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; @ misc</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ tol    : num 9.76e-05</span></span>
<span><span class="co">#&gt;  $ iter   : num 14</span></span>
<span><span class="co">#&gt;  $ runtime: 'difftime' num 0.0313060283660889</span></span>
<span><span class="co">#&gt;   ..- attr(*, "units")= chr "secs"</span></span>
<span><span class="co">#&gt;  $ w_init : num [1:3, 1:150] 0.266 0.372 0.573 0.908 0.202 ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualizing-nmf-models">Visualizing NMF Models<a class="anchor" aria-label="anchor" href="#visualizing-nmf-models"></a>
</h2>
<p>The result of <code><a href="../reference/nmf.html">RcppML::nmf</a></code> is an S34object of class
<code>nmf</code>. The <code>nmf</code> class has many useful
methods:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html" class="external-link">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"nmf"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] $        [        [[       align    biplot   coerce   dim      dimnames</span></span>
<span><span class="co">#&gt;  [9] evaluate head     predict  prod     show     sort     sparsity subset  </span></span>
<span><span class="co">#&gt; [17] summary  t       </span></span>
<span><span class="co">#&gt; see '?methods' for accessing help and source code</span></span></code></pre></div>
<p>One of these useful methods is <code>summary</code> (which in turn
has a <code>plot</code> method):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span>, group_by <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span>
<span><span class="va">species_stats</span></span>
<span><span class="co">#&gt;        group factor       stat</span></span>
<span><span class="co">#&gt; 1     setosa   nmf1 0.06364741</span></span>
<span><span class="co">#&gt; 2 versicolor   nmf1 0.46947182</span></span>
<span><span class="co">#&gt; 3  virginica   nmf1 0.46688076</span></span>
<span><span class="co">#&gt; 4     setosa   nmf2 0.04650387</span></span>
<span><span class="co">#&gt; 5 versicolor   nmf2 0.31381639</span></span>
<span><span class="co">#&gt; 6  virginica   nmf2 0.63967974</span></span>
<span><span class="co">#&gt; 7     setosa   nmf3 0.70431244</span></span>
<span><span class="co">#&gt; 8 versicolor   nmf3 0.22449607</span></span>
<span><span class="co">#&gt; 9  virginica   nmf3 0.07119149</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">species_stats</span>, stat <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/unnamed-chunk-6-1.png" width="288"></p>
<p>Notice how NMF factors capture variable information among iris
species.</p>
<p>The <code>biplot</code> method for NMF (see <code>?biplot.nmf</code>
for details) can compare the weights of different features or samples in
two factors:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/biplot.html" class="external-link">biplot</a></span><span class="op">(</span><span class="va">model</span>, factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, group_by <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/unnamed-chunk-7-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="random-restarts">Random Restarts<a class="anchor" aria-label="anchor" href="#random-restarts"></a>
</h2>
<p>NMF is randomly initialized, thus results may be slightly different
every time. To run NMF many times, set multiple seeds, and the best
model will be returned.</p>
<p>Here we run 10 factorizations at a higher tolerance, and the best
model is returned:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, k <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, tol <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># MSE of model from single random initialization</span></span>
<span><span class="fu">evaluate</span><span class="op">(</span><span class="va">model</span>, <span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.007247329</span></span>
<span></span>
<span><span class="co"># MSE of best model among 10 random restarts</span></span>
<span><span class="fu">evaluate</span><span class="op">(</span><span class="va">model2</span>, <span class="va">iris</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.006100573</span></span></code></pre></div>
<p>The second model is better.</p>
</div>
<div class="section level2">
<h2 id="l1-regularization">L1 Regularization<a class="anchor" aria-label="anchor" href="#l1-regularization"></a>
</h2>
<p>Sparse factors contain only a few non-zero values and make it easy to
identify features or samples that are important.</p>
<p>L1/LASSO regularization is the best method for introducing sparsity
into a linear model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">movielens</span><span class="op">)</span></span>
<span><span class="va">ratings</span> <span class="op">&lt;-</span> <span class="va">movielens</span><span class="op">$</span><span class="va">ratings</span></span>
<span><span class="va">model_L1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">ratings</span>, k <span class="op">=</span> <span class="fl">7</span>, L1 <span class="op">=</span> <span class="fl">0.1</span>, seed <span class="op">=</span> <span class="fl">123</span>, mask_zeros <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sparsity</span><span class="op">(</span><span class="va">model_L1</span><span class="op">)</span></span>
<span><span class="co">#&gt;    factor  sparsity model</span></span>
<span><span class="co">#&gt; 1    nmf1 0.6193432     w</span></span>
<span><span class="co">#&gt; 2    nmf2 0.8774244     w</span></span>
<span><span class="co">#&gt; 3    nmf3 0.6346005     w</span></span>
<span><span class="co">#&gt; 4    nmf4 0.6030515     w</span></span>
<span><span class="co">#&gt; 5    nmf5 0.8986294     w</span></span>
<span><span class="co">#&gt; 6    nmf6 0.2927334     w</span></span>
<span><span class="co">#&gt; 7    nmf7 0.4569434     w</span></span>
<span><span class="co">#&gt; 8    nmf1 0.6786885     h</span></span>
<span><span class="co">#&gt; 9    nmf2 0.2819672     h</span></span>
<span><span class="co">#&gt; 10   nmf3 0.6540984     h</span></span>
<span><span class="co">#&gt; 11   nmf4 0.7114754     h</span></span>
<span><span class="co">#&gt; 12   nmf5 0.4311475     h</span></span>
<span><span class="co">#&gt; 13   nmf6 0.9245902     h</span></span>
<span><span class="co">#&gt; 14   nmf7 0.9426230     h</span></span></code></pre></div>
<p>The <code>sparsity</code> S3 method for class <code>nmf</code> makes
it easy to compute the sparsity of factors, as done above.</p>
<p>Note that <code>mask_zeros = TRUE</code> in the example above. This
is because zero-valued ratings are missing, and thus should not be
considered during factorization.</p>
<p>In the above example, we regularized both <span class="math inline">\(w\)</span> and <span class="math inline">\(h\)</span>, however each model can also be
regularized separately:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_no_L1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">ratings</span>, k <span class="op">=</span> <span class="fl">7</span>, L1 <span class="op">=</span> <span class="fl">0</span>, seed <span class="op">=</span> <span class="fl">123</span>, mask_zeros <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">model_L1_h</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">ratings</span>, k <span class="op">=</span> <span class="fl">7</span>, L1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">123</span>, mask_zeros <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">model_L1_w</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">ratings</span>, k <span class="op">=</span> <span class="fl">7</span>, L1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">123</span>, mask_zeros <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize sparsity of all models in a data.frame</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu">sparsity</span><span class="op">(</span><span class="va">model_no_L1</span><span class="op">)</span>, <span class="fu">sparsity</span><span class="op">(</span><span class="va">model_L1_h</span><span class="op">)</span>, <span class="fu">sparsity</span><span class="op">(</span><span class="va">model_L1_w</span><span class="op">)</span>, <span class="fu">sparsity</span><span class="op">(</span><span class="va">model_L1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">side</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="fl">14</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"h only"</span>, <span class="fl">14</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"w only"</span>, <span class="fl">14</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"both"</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">side</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">side</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">side</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">side</span>, y <span class="op">=</span> <span class="va">sparsity</span>, color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span>, width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html" class="external-link">position_jitterdodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Regularized side of model"</span>, y <span class="op">=</span> <span class="st">"sparsity of model factors"</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/unnamed-chunk-13-1.png" width="384"></p>
<p>Note how each side of the model is regularized independently.</p>
<p>L1 regularization does not significantly affect model loss:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># L1 = 0</span></span>
<span><span class="fu">evaluate</span><span class="op">(</span><span class="va">model_no_L1</span>, <span class="va">movielens</span><span class="op">$</span><span class="va">ratings</span>, mask <span class="op">=</span> <span class="st">"zeros"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.911534</span></span>
<span></span>
<span><span class="co"># L1 = 0.1</span></span>
<span><span class="fu">evaluate</span><span class="op">(</span><span class="va">model_L1</span>, <span class="va">movielens</span><span class="op">$</span><span class="va">ratings</span>, mask <span class="op">=</span> <span class="st">"zeros"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.418375</span></span></code></pre></div>
<p>L1 regularization also does not significantly affect model
information at low penalties. Here we measure the cost of bipartite
matching between two models on a cosine distance matrix for
<code>L1 = 0</code>, <code>L1 = 0.01</code>, and
<code>L1 = 0.1</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_low_L1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">movielens</span><span class="op">$</span><span class="va">ratings</span>, k <span class="op">=</span> <span class="fl">5</span>, L1 <span class="op">=</span> <span class="fl">0.01</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cost of bipartite matching: L1 = 0 vs. L1 = 0.01</span></span>
<span><span class="fu"><a href="../reference/bipartiteMatch.html">bipartiteMatch</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/cosine.html">cosine</a></span><span class="op">(</span><span class="va">model_no_L1</span><span class="op">$</span><span class="va">w</span>, <span class="va">model_low_L1</span><span class="op">$</span><span class="va">w</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">cost</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; [1] 0.03909451</span></span>
<span></span>
<span><span class="co"># cost of bipartite matching: L1 = 0 vs. L1 = 0.1</span></span>
<span><span class="fu"><a href="../reference/bipartiteMatch.html">bipartiteMatch</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/cosine.html">cosine</a></span><span class="op">(</span><span class="va">model_no_L1</span><span class="op">$</span><span class="va">w</span>, <span class="va">model_L1</span><span class="op">$</span><span class="va">w</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">cost</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; [1] 0.01713988</span></span></code></pre></div>
<p>These cosine angles (range 0 to 1) are very small – in other words,
the models are very similar.</p>
<p>See <code><a href="../reference/cosine.html">?RcppML::cosine</a></code> for details on very fast computation
of cosine similarity.</p>
<p>In the above code, we computed cosine distance by subtracting cosine
similarity from 1, matched on this cost matrix, and divided by 10 to
find the mean cosine distance between matched factors. In both cases,
factors correspond well.</p>
<p>Thus, regularized <code><a href="../reference/nmf.html">RcppML::nmf</a></code> increases factor sparsity
without significantly affecting the loss or information content of the
model.</p>
</div>
<div class="section level2">
<h2 id="predictionrecommendation-with-nmf">Prediction/Recommendation with NMF<a class="anchor" aria-label="anchor" href="#predictionrecommendation-with-nmf"></a>
</h2>
<p>NMF models learned on some samples can be projected to other samples,
a common routine in recommendation systems or transfer learning.</p>
<p>For instance, we may train a model on some samples and then use it to
predict the values in other samples. For instance, in this dataset we
predict what bird species are likely to be encountered in a grid of land
given information about just a fraction of the species.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">hawaiibirds</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">hawaiibirds</span><span class="op">$</span><span class="va">counts</span></span>
<span></span>
<span><span class="va">test_grids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">test_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># construct a sparse masking matrix for these species and grids</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mask</span><span class="op">[</span><span class="va">test_species</span>, <span class="va">test_grids</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">mask</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nmf.html">nmf</a></span><span class="op">(</span><span class="va">A</span>, k <span class="op">=</span> <span class="fl">15</span>, mask <span class="op">=</span> <span class="va">mask</span>, tol <span class="op">=</span> <span class="fl">1e-6</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="st">"observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">A</span><span class="op">[</span><span class="va">test_species</span>, <span class="va">test_grids</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="st">"predicted"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="va">test_species</span>, <span class="va">test_grids</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="st">"set"</span> <span class="op">=</span> <span class="st">"test"</span></span>
<span>  <span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="st">"observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">A</span><span class="op">[</span><span class="op">-</span><span class="va">test_species</span>, <span class="op">-</span><span class="va">test_grids</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="st">"predicted"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="va">test_species</span>, <span class="op">-</span><span class="va">test_grids</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="st">"set"</span> <span class="op">=</span> <span class="st">"train"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">predicted</span>, color <span class="op">=</span> <span class="va">set</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">set</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 150 rows containing missing values (geom_point).</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/unnamed-chunk-17-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="cross-validation-for-rank-determination">Cross-validation for rank determination<a class="anchor" aria-label="anchor" href="#cross-validation-for-rank-determination"></a>
</h2>
<p>Cross-validation can assist in finding a reasonable factorization
rank.</p>
<p>Here we determine the optimal rank for the <code>aml</code> dataset
using cross-validation across three random replicates:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">aml</span><span class="op">)</span></span>
<span><span class="va">cv_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/crossValidate.html">crossValidate</a></span><span class="op">(</span><span class="va">aml</span><span class="op">$</span><span class="va">data</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, reps <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cv_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rep k      value</span></span>
<span><span class="co">#&gt; 1   1 1 0.03619901</span></span>
<span><span class="co">#&gt; 2   1 2 0.02974895</span></span>
<span><span class="co">#&gt; 3   1 3 0.02757322</span></span>
<span><span class="co">#&gt; 4   1 4 0.02599658</span></span>
<span><span class="co">#&gt; 5   1 5 0.02490966</span></span>
<span><span class="co">#&gt; 6   1 6 0.02413747</span></span></code></pre></div>
<p>Use the S4 <code>plot</code> method for the
<code>nmfCrossValidation</code> class to visualize:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cv_data</span><span class="op">)</span></span></code></pre></div>
<p><img src="getting_started_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>The optimal rank is around <code>k = 8</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Zach DeBruine.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
